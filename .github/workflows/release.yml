name: Release to npm

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (build only, no upload)'
        required: false
        default: false
        type: boolean

env:
  PACKAGE_NAME: agentsystems-verify

jobs:
  validate-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Package version: $VERSION"

      - name: Validate semantic versioning
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Releases must use semantic versioning (X.Y.Z)"
            echo "   Current version: $VERSION"
            exit 1
          fi
          echo "âœ… Version $VERSION is valid"

      - name: Check version doesn't exist on npm
        if: ${{ !inputs.dry_run }}
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if npm view ${{ env.PACKAGE_NAME }}@$VERSION version 2>/dev/null; then
            echo "âŒ Version $VERSION already exists on npm"
            exit 1
          fi
          echo "âœ… Version $VERSION is available"

      - name: Enforce main branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "âŒ Releases must be from main branch"
            echo "   Current branch: ${{ github.ref }}"
            exit 1
          fi
          echo "âœ… Releasing from main branch"

  build:
    runs-on: ubuntu-latest
    needs: validate-version

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Test CLI
        run: node dist/cli.js --help

      - name: Security scan
        run: |
          echo "ðŸ” Scanning for sensitive files..."

          # Check for common sensitive file patterns in dist
          if find dist -name "*.env" -o -name "*.key" -o -name "*.pem" | grep -q .; then
            echo "âŒ Found sensitive files in dist"
            exit 1
          fi

          echo "âœ… Security scan passed"

      - name: Pack for inspection
        run: npm pack

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: |
            dist/
            *.tgz
          retention-days: 7

  release:
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest
    needs: [validate-version, build]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: .

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm publish --access public
          echo "âœ… Released to npm"
          echo "View at: https://www.npmjs.com/package/${{ env.PACKAGE_NAME }}/v/${{ needs.validate-version.outputs.version }}"

      - name: Verify npm publication
        run: |
          echo "Verifying publication..."
          sleep 10

          for i in {1..3}; do
            if npm view ${{ env.PACKAGE_NAME }}@${{ needs.validate-version.outputs.version }} version; then
              echo "âœ… Package verified on npm"
              exit 0
            fi
            echo "Attempt $i: waiting for npm propagation..."
            sleep 10
          done
          echo "âš ï¸ Could not verify, but publish likely succeeded"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="v${{ needs.validate-version.outputs.version }}"

          if gh release view "${TAG}" &>/dev/null; then
            echo "âœ… Release ${TAG} already exists, skipping creation"
          else
            echo "ðŸ“¦ Creating release ${TAG}..."
            gh release create "${TAG}" \
              --title "${TAG}" \
              --target ${{ github.sha }} \
              --notes $'agentsystems-verify ${{ needs.validate-version.outputs.version }}\n\nInstall: npm install -g ${{ env.PACKAGE_NAME }}\n\nOr run directly: npx ${{ env.PACKAGE_NAME }} ticket.json logs.zip\n\nnpm: https://www.npmjs.com/package/${{ env.PACKAGE_NAME }}/v/${{ needs.validate-version.outputs.version }}' \
              *.tgz
            echo "âœ… Release created successfully"
          fi
